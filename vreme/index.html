<!DOCTYPE html>
<html lang="sl">

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Vreme</title>
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
</head>

<body>
    <div id="demo"></div></br>
    <div id="plot1" style="width:100%;"></div>
    <div id="plot2" style="width:100%;"></div>

    <script>
        const x = document.getElementById("demo");

        function getLocation() {
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(
                    showPosition, showError, {
                    enableHighAccuracy: true,
                    maximumAge: Infinity,
                    timeout: 15000
                });
            } else {
                x.innerHTML = "Geolocation is not supported by this browser.";
            }
        }

        function httpGet(theUrl) {
            var xmlHttp = new XMLHttpRequest();
            xmlHttp.open("GET", theUrl, false);
            xmlHttp.send(null);
            return xmlHttp.responseText;
        }

        function showPosition(position) {
            const response = httpGet("https://api.open-meteo.com/v1/dwd-icon?latitude=" + position.coords.latitude +
                "&longitude=" + position.coords.longitude + "&hourly=temperature_2m,precipitation,wind_speed_10m,direct_normal_irradiance&timezone=Europe%2FBerlin&past_days=3&forecast_days=8");
            const obj = JSON.parse(response);
            let hourly_times = obj.hourly.time.map(datetime => new Date(datetime));

            const tempColor = '#DC143C';  // rdeča
            const padavColor = '#4682B4';  // modra
            const veterColor = '#008000';  // zelena
            const sonColor = '#FF8C00';  // oranžna

            const max_wind = Math.max(Math.max(...obj.hourly.wind_speed_10m), 20);
            const max_precip = Math.max(Math.max(...obj.hourly.precipitation), 5);

            var date = new Date();

            // Prvi graf (Temperatura in Obsevanje)
            const data1 = [
                { x: hourly_times, y: obj.hourly.temperature_2m, mode: "lines", name: 'Temperatura [' + obj.hourly_units.temperature_2m + ']', line: { color: tempColor } },
                { x: hourly_times, y: obj.hourly.direct_normal_irradiance, mode: "lines", name: 'Sonce [' + obj.hourly_units.direct_normal_irradiance + ']', line: { color: sonColor } }
            ];

            const layout1 = {
                title: "Temperatura in Obsevanje",
                xaxis: { title: "Čas" },
                yaxis: { title: "Temperatura", tickfont: { color: tempColor } },
                yaxis2: { title: "Obsevanje", tickfont: { color: sonColor }, overlaying: 'y', side: 'right' },
                legend: { orientation: "h", y: -0.2 }
            };

            // Drugi graf (Veter in Padavine)
            const data2 = [
                { x: hourly_times, y: obj.hourly.wind_speed_10m, mode: "lines", name: 'Hitrost vetra [' + obj.hourly_units.wind_speed_10m + ']', line: { color: veterColor } },
                { x: hourly_times, y: obj.hourly.precipitation, type: "bar", name: 'Padavine [' + obj.hourly_units.precipitation + ']', marker: { color: padavColor }, opacity: 0.5 }
            ];

            const layout2 = {
                title: "Hitrost vetra in Padavine",
                xaxis: { title: "Čas" },
                yaxis: { title: "Hitrost vetra", tickfont: { color: veterColor } },
                yaxis2: { title: "Padavine", tickfont: { color: padavColor }, overlaying: 'y', side: 'right' },
                legend: { orientation: "h", y: -0.2 }
            };

            Plotly.newPlot("plot1", data1, layout1, { displayModeBar: true });
            Plotly.newPlot("plot2", data2, layout2, { displayModeBar: true });
        }

        function showError(error) {
            switch (error.code) {
                case error.PERMISSION_DENIED:
                    x.innerHTML = "User denied the request for Geolocation.";
                    break;
                case error.POSITION_UNAVAILABLE:
                    x.innerHTML = "Location information is unavailable.";
                    break;
                case error.TIMEOUT:
                    x.innerHTML = "The request to get user location timed out.";
                    break;
                case error.UNKNOWN_ERROR:
                    x.innerHTML = "An unknown error occurred.";
                    break;
            }
        }

        getLocation();
    </script>
</body>
</html>
