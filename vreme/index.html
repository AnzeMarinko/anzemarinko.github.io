<!DOCTYPE html>
<html lang="sl">

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="keywords" content="Vreme, DWD D2">
    <meta name="description" content="Lokalna vremenska napoved">
    <meta name="author" content="Anže Marinko">

    <link rel="icon" type="image/x-icon" href="favicon_io/favicon.ico">
	<meta name="theme-color" content="#87b1f8">
	<link rel="apple-touch-icon" sizes="180x180" href="favicon_io/apple-touch-icon.png">
	<link rel="icon" type="image/png" sizes="32x32" href="favicon_io/favicon-32x32.png">
	<link rel="icon" type="image/png" sizes="16x16" href="favicon_io/favicon-16x16.png">
	<link rel="icon" type="image/png" sizes="192x192" href="favicon_io/android-chrome-192x192.png">
	<link rel="icon" type="image/png" sizes="512x512" href="favicon_io/android-chrome-512x512.png">
	<link rel="manifest" href="favicon_io/site.webmanifest">
	<link rel="shortcut icon" href="favicon_io/favicon.ico">
	<meta name="msapplication-TileColor" content="#323F47">

	<!-- Facebook Meta Tags -->
	<meta property="og:title" content="Vreme">
	<meta property="og:type" content="website">
	<meta property="og:url" content="https://anzemarinko.github.io/vreme">
	<meta property="og:image" content="https://anzemarinko.github.io/vreme/favicon_io/android-chrome-512x512.png">
	<meta property="og:site_name" content="Vreme">
	<meta property="og:description" content="Lokalna vremenska napoved">

	<!-- Twitter Meta Tags -->
	<meta name="twitter:card" content="summary_large_image">
	<meta property="twitter:domain" content="anzemarinko.github.io">
	<meta property="twitter:url" content="https://anzemarinko.github.io/vreme">
	<meta name="twitter:title" content="Vreme">
	<meta name="twitter:description" content="Lokalna vremenska napoved">
	<meta name="twitter:image" content="https://anzemarinko.github.io/vreme/favicon_io/android-chrome-512x512.png">

    <title>Vreme</title>
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 10px;
            background-color: #87b1f8;
            text-align: center;
        }

        #demo {
            font-size: 10px;
        }

        h1 {
            color: #034a80;
            margin-bottom: 10px;
        }

        h3 {
            color: #0169b8;
            margin-bottom: 10px;
        }

        .container {
            max-width: 900px;
            margin: auto;
            background: white;
            padding: 5px;
            border-radius: 10px;
            box-shadow: 0px 4px 10px rgba(0, 0, 0, 0.1);
        }

        .graph {
            width: 100%;
            margin-top: 20px;
        }

        #radar img {
            width: 95%;
            max-width: 600px;
            border-radius: 15px;
        }

        #sun p {
            margin: 5px 0;
            font-size: 16px;
        }
    </style>
</head>

<body>
    <div class="container">
        <h1>Vreme</h1>
        <div id="demo"></div>

        <div id="sun">
            <h3>Sonce</h3>
            <p id="sunrise"></p>
            <p id="sunset"></p>
        </div>
        
        <div id="grafi">
            <h3>Napoved</h3>
            <div id="plot1" class="graph"></div>
            <div id="plot2" class="graph"></div>
        </div>

        <div id="radar">
            <h3>Radarska slika padavin</h3>
            <img src="https://meteo.arso.gov.si/uploads/probase/www/observ/radar/si0-rm-anim.gif">
        </div>
    </div>

    <script>
        const x = document.getElementById("demo");

        function getLocation() {
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(
                    saveAndShowPosition, useLastKnownPosition, {
                    enableHighAccuracy: true,
                    maximumAge: Infinity,
                    timeout: 15000
                });
            } else {
                useLastKnownPosition();
            }
        }

        function saveAndShowPosition(position) {
            const latitude = position.coords.latitude;
            const longitude = position.coords.longitude;
            localStorage.setItem("lastLatitude", latitude);
            localStorage.setItem("lastLongitude", longitude);
            fetchWeather(latitude, longitude);
        }

        function useLastKnownPosition() {
            const lastLatitude = localStorage.getItem("lastLatitude");
            const lastLongitude = localStorage.getItem("lastLongitude");
            if (lastLatitude && lastLongitude) {
                fetchWeather(lastLatitude, lastLongitude);
                x.innerHTML = "Uporabljena zadnja znana lokacija.";
            } else {
                x.innerHTML = "Geolocation ni na voljo in ni shranjene lokacije.";
            }
        }

        function httpGet(theUrl) {
            var xmlHttp = new XMLHttpRequest();
            xmlHttp.open("GET", theUrl, false);
            xmlHttp.send(null);
            return xmlHttp.responseText;
        }

        function fetchWeather(latitude, longitude) {
            const response = httpGet("https://api.open-meteo.com/v1/dwd-icon?latitude=" + latitude +
                "&longitude=" + longitude + "&hourly=temperature_2m,precipitation,wind_speed_10m,direct_normal_irradiance&daily=sunrise,sunset&timezone=Europe%2FBerlin&past_days=3&forecast_days=8");
            const obj = JSON.parse(response);
            let hourly_times = obj.hourly.time.map(datetime => new Date(datetime));

            const tempColor = '#DC143C';  // rdeča
            const padavColor = '#4682B4';  // modra
            const veterColor = '#008000';  // zelena
            const sonColor = '#FF8C00';  // oranžna
            const currentTime = new Date();

            const endDate = new Date(currentTime);
            endDate.setDate(endDate.getDate() + 3);

            // Prvi graf (Temperatura in Obsevanje)
            const data1 = [
                { x: hourly_times, y: obj.hourly.temperature_2m, mode: "lines", name: 'Temperatura [' + obj.hourly_units.temperature_2m + ']', line: { color: tempColor }, yaxis: "y" },
                { x: hourly_times, y: obj.hourly.direct_normal_irradiance, mode: "lines", name: 'Sonce [' + obj.hourly_units.direct_normal_irradiance + ']', line: { color: sonColor }, yaxis: "y2" },
                { x: [currentTime, currentTime], y: [Math.min(...obj.hourly.temperature_2m), Math.max(...obj.hourly.temperature_2m)], mode: "lines", line: { color: "gold", dash: "dash", width: 5 }, name: "Trenutni čas" }
            ];

            const layout1 = {
                title: "Temperatura in sonce",
                xaxis: { 
                    title: "Čas", 
                    range: [currentTime, endDate],
                    fixedrange: false, 
                    showspikes: true,
                    showline: true },
                yaxis: { 
                    title: "Temperatura",
                    tickfont: { color: tempColor },
                    showspikes: true,
                    showline: true,
                    fixedrange: true },
                yaxis2: { 
                    title: "Sonce", 
                    tickfont: { color: sonColor }, 
                    overlaying: 'y', 
                    side: 'right', 
                    showspikes: true,
                    showline: true,
                    fixedrange: true },
                legend: { orientation: "h", y: -0.2 },
                dragmode: 'pan',  // Set pan as default mode
                spikedistance: -1, // Enables global spike lines
                margin: {
                    t: 40,  // Top margin
                    b: 40,  // Bottom margin
                    l: 40,  // Left margin
                    r: 40,  // Right margin
                },
                autosize: true,
            };

            // Drugi graf (Veter in Padavine)
            const data2 = [
                { x: hourly_times, y: obj.hourly.wind_speed_10m, mode: "lines", name: 'Hitrost vetra [' + obj.hourly_units.wind_speed_10m + ']', line: { color: veterColor }, yaxis: "y" },
                { x: hourly_times, y: obj.hourly.precipitation, type: "bar", name: 'Padavine [' + obj.hourly_units.precipitation + ']', marker: { color: padavColor }, opacity: 0.5, yaxis: "y2" },
                { x: [currentTime, currentTime], y: [0, Math.max(...obj.hourly.wind_speed_10m)], mode: "lines", line: { color: "gold", dash: "dash", width: 5 }, name: "Trenutni čas" }
            ];

            const layout2 = {
                title: "Hitrost vetra in padavine",
                xaxis: { 
                    title: "Čas", 
                    range: [currentTime, endDate],
                    fixedrange: false, 
                    showspikes: true,
                    showline: true },
                yaxis: { 
                    title: "Hitrost vetra",
                    tickfont: { color: veterColor },
                    showspikes: true,
                    showline: true,
                    fixedrange: true },
                yaxis2: { 
                    title: "Padavine", 
                    tickfont: { color: padavColor }, 
                    overlaying: 'y', 
                    side: 'right', 
                    showspikes: true,
                    showline: true,
                    fixedrange: true },
                legend: { orientation: "h", y: -0.2 },
                dragmode: 'pan',  // Set pan as default mode
                spikedistance: -1, // Enables global spike lines

                margin: {
                    t: 40,  // Top margin
                    b: 40,  // Bottom margin
                    l: 40,  // Left margin
                    r: 40,  // Right margin
                },
                autosize: true,
            };

            const layoutOptions = {
                showspikes: true,
                displaylogo: false,
                displayModeBar: true,
                modeBarButtonsToRemove: ['toImage', 'pan2d', 'zoom2d', 'select2d', 'lasso2d', 'zoomIn2d', 'zoomOut2d', 'autoScale2d', 'hoverClosestCartesian', 'hoverCompareCartesian', 'toggleSpikelines'],
            };

            Plotly.newPlot("plot1", data1, layout1, layoutOptions);
            Plotly.newPlot("plot2", data2, layout2, layoutOptions);

            document.getElementById("sunrise").innerHTML = `Vzhod: ${obj.daily.sunrise[0].split('T')[1]}`;
            document.getElementById("sunset").innerHTML = `Zahod: ${obj.daily.sunset[0].split('T')[1]}`;
        }

        getLocation();
    </script>
</body>
</html>
