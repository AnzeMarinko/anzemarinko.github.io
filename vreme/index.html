<!DOCTYPE html>
<html lang="">

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Vreme</title>
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
</head>

<body>

    <div id="demo"></div></br>
    <div id="myPlot" style="width:100%;"></div>

    <script>
        const x = document.getElementById("demo");

        function getLocation() {
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(
                    showPosition, showError, {
                    enableHighAccuracy: true,
                    maximumAge: Infinity,
                    timeout: 15000
                }
                );
            } else {
                x.innerHTML = "Geolocation is not supported by this browser.";
            }
        }

        function httpGet(theUrl) {
            var xmlHttp = new XMLHttpRequest();
            xmlHttp.open("GET", theUrl, false);
            xmlHttp.send(null);
            return xmlHttp.responseText;
        }

        function showPosition(position) {
            const response = httpGet("https://api.open-meteo.com/v1/dwd-icon?latitude=" + position.coords.latitude +
                "&longitude=" + position.coords.longitude + "&hourly=temperature_2m,precipitation,wind_speed_10m,direct_normal_irradiance&timezone=Europe%2FBerlin&past_days=3&forecast_days=8");
            const obj = JSON.parse(response);
            var date = new Date();
            let hourly_times = obj.hourly.time.map(datetime => new Date(datetime));

            const tempColor = '#DC143C';  // rdeča
            const padavColor = '#4682B4';  // modra
            const veterColor = '#008000';  // zelena
            const sonColor = '#FF8C00';  // oranžna

            const max_wind = Math.max(Math.max(...obj.hourly.wind_speed_10m), 20);
            const max_precip = Math.max(Math.max(...obj.hourly.precipitation), 5);

            // Define Data
            const data = [
                { x: hourly_times, y: obj.hourly.temperature_2m, mode: "lines", name: 'Temperatura [' + obj.hourly_units.temperature_2m + "]", line: { color: tempColor } },
                { x: hourly_times, y: obj.hourly.direct_normal_irradiance, mode: "lines", name: "Sonce [" + obj.hourly_units.direct_normal_irradiance + "]", yaxis: "y2", line: { color: sonColor } },
                { x: hourly_times, y: obj.hourly.wind_speed_10m, mode: "lines", name: "Hitrost vetra [" + obj.hourly_units.wind_speed_10m + "]", yaxis: "y3", line: { color: veterColor } },
                { x: hourly_times, y: obj.hourly.precipitation, type: "bar", name: "Padavine [" + obj.hourly_units.precipitation + "]", yaxis: "y4", marker: { color: padavColor }, opacity: 0.5 },
                { x: [date, date], y: [0, max_wind], type: "line", line: { color: "gold" }, yaxis: "y3", name: "Ta trenutek" },
            ];

            //Define Layout
            const layout = {
                title: "Vremenska napoved na trenutni lokaciji (" + obj.elevation + " m.n.v.)",
                xaxis: { title: "Čas" },
                yaxis: {
                    tickfont: { color: tempColor }
                },
                yaxis2: {
                    tickfont: { color: sonColor },
                    showgrid: false,
                    overlaying: 'y',
                    side: 'right'
                },
                yaxis3: {
                    tickfont: { color: veterColor },
                    range: [0, max_wind],
                    showgrid: false,
                    overlaying: 'y',
                    position: 0.01
                },
                yaxis4: {
                    tickfont: { color: padavColor },
                    range: [0, max_precip],
                    showgrid: false,
                    overlaying: 'y',
                    side: 'right',
                    position: 0.99
                },
            };
            Plotly.newPlot("myPlot",
                data,
                layout, { displayModeBar: true }
            );
        }

        function showError(error) {
            switch (error.code) {
                case error.PERMISSION_DENIED:
                    x.innerHTML = "User denied the request for Geolocation."
                    break;
                case error.POSITION_UNAVAILABLE:
                    x.innerHTML = "Location information is unavailable."
                    break;
                case error.TIMEOUT:
                    x.innerHTML = "The request to get user location timed out."
                    break;
                case error.UNKNOWN_ERROR:
                    x.innerHTML = "An unknown error occurred."
                    break;
            }
        }
        getLocation();
    </script>
</body>

</html>